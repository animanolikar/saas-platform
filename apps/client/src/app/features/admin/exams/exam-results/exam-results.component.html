<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a routerLink="/admin/exams" class="text-decoration-none">Exams</a></li>
                    <li class="breadcrumb-item active">Results</li>
                </ol>
            </nav>
            <h2 class="fw-bold mb-1">Exam Results</h2>
            <p class="text-muted">View student performance and proctoring logs.</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success" (click)="exportToCsv()" [disabled]="!attempts.length">
                <i class="bi bi-file-earmark-spreadsheet me-1"></i> Export CSV
            </button>
            <button class="btn btn-outline-secondary" (click)="loadAttempts()">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4" *ngIf="stats">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 h-100">
                <div class="d-flex align-items-center mb-1">
                    <div class="rounded-circle bg-primary-subtle p-2 me-3 text-primary">
                        <i class="bi bi-people fs-4"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Total Attempts</div>
                        <div class="fs-4 fw-bold">{{ stats.totalAttempts }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 h-100">
                <div class="d-flex align-items-center mb-1">
                    <div class="rounded-circle bg-info-subtle p-2 me-3 text-info">
                        <i class="bi bi-graph-up fs-4"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Average Score</div>
                        <div class="fs-4 fw-bold">{{ stats.averageScore | number:'1.1-1' }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 h-100">
                <div class="d-flex align-items-center mb-1">
                    <div class="rounded-circle bg-success-subtle p-2 me-3 text-success">
                        <i class="bi bi-check-circle fs-4"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Pass Rate</div>
                        <div class="fs-4 fw-bold">{{ stats.passRate | number:'1.0-1' }}%</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 h-100">
                <div class="d-flex align-items-center mb-1">
                    <div class="rounded-circle bg-warning-subtle p-2 me-3 text-warning">
                        <i class="bi bi-trophy fs-4"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Highest Score</div>
                        <div class="fs-4 fw-bold">{{ stats.highestScore }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Student</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Submitted</th>
                            <th>Warnings</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngIf="loading">
                            <td colspan="6" class="text-center py-5 text-muted">
                                <div class="spinner-border spinner-border-sm text-primary me-2"></div> Loading
                                results...
                            </td>
                        </tr>
                        <tr *ngIf="!loading && attempts.length === 0">
                            <td colspan="6" class="text-center py-5 text-muted">No attempts found for this exam yet.
                            </td>
                        </tr>
                        <tr *ngFor="let attempt of attempts">
                            <td class="ps-4">
                                <div class="fw-medium">{{ attempt.user.firstName }} {{ attempt.user.lastName }}</div>
                                <div class="small text-muted">{{ attempt.user.email }}</div>
                            </td>
                            <td>
                                <span class="badge" [class.bg-success-subtle]="attempt.result?.passed"
                                    [class.text-success-emphasis]="attempt.result?.passed"
                                    [class.bg-danger-subtle]="!attempt.result?.passed"
                                    [class.text-danger-emphasis]="!attempt.result?.passed">
                                    {{ attempt.result?.passed ? 'PASSED' : 'FAILED' }}
                                </span>
                            </td>
                            <td>
                                <div class="fw-bold">{{ attempt.totalScore }} / {{ attempt.result?.maxMarks }}</div>
                                <div class="small text-muted">{{ attempt.result?.percentage | number:'1.0-1' }}%</div>
                            </td>
                            <td>
                                {{ attempt.submittedAt | date:'short' }}
                            </td>
                            <td>
                                <!-- Warnings Badge -->
                                <!-- We don't have warning count in DB directly yet, need to count telemetry or infer. 
                                     For MVP, we assume we might add it or just show 0 if not tracked.
                                     Actually schema has `telemetry` JSON. We didn't add a `warningCount` column.
                                     Wait, the plan said "Warnings (Badge)". 
                                     I will update the backend query to count telemetry events if possible, or just skip warning count in table for now 
                                     and show it in detailed view.
                                     Let's show "View Details" to see warnings. -->
                                <span class="badge bg-light text-dark border">View Details</span>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-primary" (click)="viewDetails(attempt.id)">
                                    View Details <i class="bi bi-arrow-right ms-1"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>